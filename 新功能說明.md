# 新功能說明

## 更新日期
2025-12-29

## 新增功能

### 1. RSP_STATUS 命令

#### 功能描述
新增 RSP_STATUS 命令按鈕，用於向 TPT 發送狀態請求命令。

#### 命令格式
```json
{
  "type": "RSP_STATUS",
  "timestamp": "2025-10-17T15:35:00+08:00",
  "msg_id": "B8A7F6E5D4C3B2AA",
  "work_station_name": "TPT-001"
}
```

#### 使用方式
1. 在前端頁面點擊「📊 RSP_STATUS」按鈕
2. 系統會自動發送 RSP_STATUS 命令到 TPT
3. 命令會顯示在通訊 Log 中

#### 技術實現
- **前端**: 新增 `btn-rsp-status` 按鈕和 `sendRspStatusCommand()` 函數
- **後端**: 新增 `/api/cmd/rsp_status` API 端點
- **狀態管理**: 新增 `SendRspStatus()` 方法

---

### 2. 自訂命令 (User Command)

#### 功能描述
提供使用者自訂命令類型的功能，可以輸入任意命令類型並發送到 TPT。

#### 命令格式
```json
{
  "type": "aaa",  // 使用者輸入的命令類型
  "timestamp": "2025-10-17T15:35:00+08:00",
  "msg_id": "B8A7F6E5D4C3B2AA"
}
```

#### 使用方式
1. 在「自訂命令」區塊的輸入框中輸入命令類型（例如：`aaa`）
2. 點擊「📤 發送自訂命令」按鈕
3. 系統會將該命令類型發送到 TPT
4. 命令會顯示在通訊 Log 中

#### 技術實現
- **前端**: 
  - 新增 `user-command-input` 輸入框
  - 新增 `btn-user-command` 按鈕
  - 新增 `sendUserCommand()` 函數
- **後端**: 
  - 新增 `/api/cmd/user_command` API 端點
  - 新增 `UserCommandRequest` 結構
- **狀態管理**: 新增 `SendUserCommand()` 方法

---

## 修改的檔案清單

### 前端檔案
1. **TPT_DYMesTest/static/index.html**
   - 新增 RSP_STATUS 按鈕
   - 新增自訂命令輸入區塊

2. **TPT_DYMesTest/static/script.js**
   - 新增 `sendRspStatusCommand()` 函數
   - 新增 `sendUserCommand()` 函數
   - 更新事件監聽器

3. **TPT_DYMesTest/static/style.css**
   - 新增 `.btn-info` 樣式（紫色，用於 RSP_STATUS）
   - 新增 `.btn-custom` 樣式（青綠色，用於自訂命令）

### 後端檔案
4. **TPT_DYMesTest/core/server_http.go**
   - 新增 `/api/cmd/rsp_status` 路由
   - 新增 `/api/cmd/user_command` 路由
   - 新增 `handleRspStatusCommand()` 處理函數
   - 新增 `handleUserCommand()` 處理函數
   - 新增 `UserCommandRequest` 結構

5. **TPT_DYMesTest/core/state_manager.go**
   - 新增 `SendRspStatus()` 方法
   - 新增 `SendUserCommand()` 方法

---

## 測試步驟

### 測試 RSP_STATUS 命令
1. 啟動伺服器：執行 `Build&Run.bat`
2. 開啟瀏覽器訪問 `http://localhost:5179`
3. 確認 TPT 已連線（TCP 連線狀態為「已連線」）
4. 點擊「📊 RSP_STATUS」按鈕
5. 檢查通訊 Log，應該會看到發送的 RSP_STATUS 命令

### 測試自訂命令
1. 確認 TPT 已連線
2. 在「自訂命令」輸入框中輸入 `aaa`
3. 點擊「📤 發送自訂命令」按鈕
4. 檢查通訊 Log，應該會看到發送的自訂命令，type 為 `aaa`
5. 嘗試輸入其他命令類型（例如：`test123`）並驗證

---

## 注意事項

1. **連線檢查**: 兩個命令都會檢查 TPT 是否已連線，未連線時會顯示錯誤訊息
2. **必填欄位**: 自訂命令的 type 欄位為必填，空白時會提示錯誤
3. **時間戳記**: 所有命令都會自動產生符合 ISO 8601 格式的時間戳記（+08:00 時區）
4. **訊息 ID**: 系統會自動產生唯一的訊息 ID
5. **工作站名稱**: RSP_STATUS 命令會自動帶入當前連線的工作站名稱

---

## 未來改進建議

1. 可以考慮新增常用自訂命令的快捷按鈕
2. 可以新增命令歷史記錄功能
3. 可以新增命令範本選擇功能
4. 可以新增批次發送命令的功能
